#pragma once

#ifdef __cplusplus
	#define CRY_FUN_SPEC inline constexpr
	#define CRY_IDTF(name) name
	#define STRUCTED_VAR

	#include <string>
	#include <cstddef>
	#define CRY_STRING_LENGTH_T size_t
#else
	#define CRY_FUN_SPEC inline
	#define CRY_IDTF(name) cry##name
	#define STRUCTED_VAR struct
	#define CRY_STRING_LENGTH_T int
#endif

#define CRY_STD_STR_TYPE const char*

#ifdef __cplusplus
namespace cry {
#endif

	struct CRY_IDTF(Engine) {

		#ifdef __cplusplus
			struct Worker;
		#endif

		CRY_STD_STR_TYPE (*proc)(CRY_STD_STR_TYPE str, CRY_STD_STR_TYPE key);
        };


	struct
	#ifdef __cplusplus
		Engine::Worker
	#else
		cryEngineWorker
	#endif
	{
		STRUCTED_VAR CRY_IDTF(Engine) *engine;
		CRY_STD_STR_TYPE val;

		#ifdef __cplusplus
		inline constexpr Worker(Engine *engine, CRY_STD_STR_TYPE val) : engine(engine), val(val) {}
		inline constexpr CRY_STD_STR_TYPE proc(CRY_STD_STR_TYPE key);
		#endif
	};

	CRY_FUN_SPEC CRY_STD_STR_TYPE
	#ifdef __cplusplus
	Engine::Worker::proc
	#else
	cryEngineWorker_proc
	#endif
	(
	#ifndef __cplusplus
		struct cryEngineWorker *this, // Add " cryEngineWorker* " when it's C (when __cplusplus isn't defined) for compability between C and C++
	#endif
		CRY_STD_STR_TYPE key
	) {
		return this->engine->proc(this->val, key);
	}

	struct CRY_IDTF(StringPack) {
		CRY_STD_STR_TYPE val;
		CRY_STRING_LENGTH_T len;

	        #ifdef __cplusplus
		inline StringPack(std::string val) : val(val.c_str()), len(val.size()) {} // don't use it unless it's necessary, can't be declarated constexpr since accepting std::string as paramter !
		inline constexpr StringPack(CRY_STD_STR_TYPE val, CRY_STRING_LENGTH_T len);
		#endif

		#ifdef __cplusplus
		inline constexpr Engine::Worker with(Engine *engine);
		inline constexpr Engine::Worker operator()(Engine *engine) {
			return with(engine);
		}
		#endif
	};

	CRY_FUN_SPEC
	#ifdef __cplusplus
		StringPack::StringPack(CRY_STD_STR_TYPE val, CRY_STRING_LENGTH_T len) : val(val), len(len) {}
	#else
		struct cryStringPack
		cryStringPack_new(CRY_STD_STR_TYPE val, CRY_STRING_LENGTH_T len) {
			struct cryStringPack ret;
			ret.val = val;
			ret.len = len;
			return ret;
		}
	#endif


	CRY_FUN_SPEC
	#ifdef __cplusplus
		Engine::Worker
		StringPack::with(
	#else
		struct cryEngineWorker
		cryStringPack_with(STRUCTED_VAR cryStringPack *this,
	#endif
		STRUCTED_VAR CRY_IDTF(Engine) *engine
	) {
		#ifdef __cplusplus
	                return Engine::Worker(engine, val);
        	#else
	                struct cryEngineWorker worker;
			worker.engine = engine;
			return worker;
                #endif
	}


	#ifdef __cplusplus
	inline constexpr StringPack operator"" _cry(const char* str, size_t len) {
		return StringPack ( str, len );
	}
	#endif

#ifdef __cplusplus
}
#endif
